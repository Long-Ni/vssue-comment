<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>详解并发编程三大特性 | Ni&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="$page.excerpt">
    
    <link rel="preload" href="/vssue-comment/assets/css/0.styles.02c2761a.css" as="style"><link rel="preload" href="/vssue-comment/assets/js/app.9fa4f4bb.js" as="script"><link rel="preload" href="/vssue-comment/assets/js/13.044f1fde.js" as="script"><link rel="preload" href="/vssue-comment/assets/js/3.f0de84e7.js" as="script"><link rel="preload" href="/vssue-comment/assets/js/27.d4ae83e5.js" as="script"><link rel="prefetch" href="/vssue-comment/assets/js/10.23cc3d6b.js"><link rel="prefetch" href="/vssue-comment/assets/js/11.c63e2dcc.js"><link rel="prefetch" href="/vssue-comment/assets/js/12.d7671ee7.js"><link rel="prefetch" href="/vssue-comment/assets/js/14.399fc32e.js"><link rel="prefetch" href="/vssue-comment/assets/js/15.37bef016.js"><link rel="prefetch" href="/vssue-comment/assets/js/16.2ae3cc61.js"><link rel="prefetch" href="/vssue-comment/assets/js/17.10c0352f.js"><link rel="prefetch" href="/vssue-comment/assets/js/18.02aac107.js"><link rel="prefetch" href="/vssue-comment/assets/js/19.ac0b8b1d.js"><link rel="prefetch" href="/vssue-comment/assets/js/20.656ccc17.js"><link rel="prefetch" href="/vssue-comment/assets/js/21.d1f01d1a.js"><link rel="prefetch" href="/vssue-comment/assets/js/22.6e251d71.js"><link rel="prefetch" href="/vssue-comment/assets/js/23.caaa7b12.js"><link rel="prefetch" href="/vssue-comment/assets/js/24.33d428f1.js"><link rel="prefetch" href="/vssue-comment/assets/js/25.207f6b5f.js"><link rel="prefetch" href="/vssue-comment/assets/js/26.398d8fee.js"><link rel="prefetch" href="/vssue-comment/assets/js/28.66c58624.js"><link rel="prefetch" href="/vssue-comment/assets/js/29.a6686645.js"><link rel="prefetch" href="/vssue-comment/assets/js/30.242e18b7.js"><link rel="prefetch" href="/vssue-comment/assets/js/31.7da4eecc.js"><link rel="prefetch" href="/vssue-comment/assets/js/32.9b8f3ea0.js"><link rel="prefetch" href="/vssue-comment/assets/js/33.075dbe36.js"><link rel="prefetch" href="/vssue-comment/assets/js/34.838ce186.js"><link rel="prefetch" href="/vssue-comment/assets/js/35.3bbd155f.js"><link rel="prefetch" href="/vssue-comment/assets/js/36.a07ab564.js"><link rel="prefetch" href="/vssue-comment/assets/js/37.50ef72a3.js"><link rel="prefetch" href="/vssue-comment/assets/js/38.75b498ed.js"><link rel="prefetch" href="/vssue-comment/assets/js/39.3b1e3afb.js"><link rel="prefetch" href="/vssue-comment/assets/js/4.79c2a3ee.js"><link rel="prefetch" href="/vssue-comment/assets/js/40.0a6fdf1b.js"><link rel="prefetch" href="/vssue-comment/assets/js/41.9be8ec60.js"><link rel="prefetch" href="/vssue-comment/assets/js/42.9ce4d2b3.js"><link rel="prefetch" href="/vssue-comment/assets/js/43.c76f9c55.js"><link rel="prefetch" href="/vssue-comment/assets/js/44.4749cc3b.js"><link rel="prefetch" href="/vssue-comment/assets/js/45.605778e4.js"><link rel="prefetch" href="/vssue-comment/assets/js/46.fd2913a3.js"><link rel="prefetch" href="/vssue-comment/assets/js/47.5b787534.js"><link rel="prefetch" href="/vssue-comment/assets/js/48.7cf6064e.js"><link rel="prefetch" href="/vssue-comment/assets/js/49.ffa11e3d.js"><link rel="prefetch" href="/vssue-comment/assets/js/5.6a98c4eb.js"><link rel="prefetch" href="/vssue-comment/assets/js/50.69284de8.js"><link rel="prefetch" href="/vssue-comment/assets/js/6.0cbbe057.js"><link rel="prefetch" href="/vssue-comment/assets/js/7.feaf1269.js"><link rel="prefetch" href="/vssue-comment/assets/js/8.9c40e8a4.js"><link rel="prefetch" href="/vssue-comment/assets/js/9.b2c8bfda.js"><link rel="prefetch" href="/vssue-comment/assets/js/vuejs-paginate.8412c6fc.js">
    <link rel="stylesheet" href="/vssue-comment/assets/css/0.styles.02c2761a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/vssue-comment/" class="nav-link home-link">Ni's Blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/vssue-comment/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/vssue-comment/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/vssue-comment/" class="nav-link mobile-home-link">Ni's Blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/vssue-comment/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/vssue-comment/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        详解并发编程三大特性
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">Ni</span> <span itemprop="address">   in 大连</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-06-28 14:00:00+0800">
      Mon Jun 28 2021
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/vssue-comment/tag/Java" data-v-42ccfcd5><span data-v-42ccfcd5>Java</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p><strong>并发编程三大核心基础理论：原子性、可见行、有序性。</strong></p> <p>包含以下内容：</p> <ul><li>定义—— What</li> <li>各特性问题产生的原因—— Why</li> <li>如何保证其特性—— How</li></ul> <p>目录：</p> <div><ul><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_1-原子性">1. 原子性</a><ul><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_1-1-原子性问题产生的原因">1.1 原子性问题产生的原因</a></li><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_1-2-案例分析-i">1.2 案例分析：i++</a></li><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_1-3-如何保证原子性">1.3 如何保证原子性</a></li></ul></li><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_2-可见性">2. 可见性</a><ul><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_2-1-可见性问题产生的原因">2.1 可见性问题产生的原因</a></li><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_2-2-案例分析">2.2 案例分析</a></li><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_2-3-如何保证可见性">2.3 如何保证可见性</a></li></ul></li><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_3-有序性">3. 有序性</a><ul><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_3-1-有序性问题产生的原因">3.1 有序性问题产生的原因</a></li><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_3-2-实例分析-单例模式之-double-check-lock">3.2 实例分析：单例模式之 Double Check Lock</a></li><li><a href="/vssue-comment/2021/06/28/_03-atomicity-visibility-ordering/#_3-3-如何保证有序性">3.3 如何保证有序性</a></li></ul></li></ul></div> <h2 id="_1-原子性"><a href="#_1-原子性" class="header-anchor">#</a> 1. 原子性</h2> <p>一个或者多个操作，要么全部执行且在执行过程中未被打断，要么全部不执行，就叫做原子性。</p> <blockquote><p>原子操作：不可分割、中断的一个或者一系列操作。</p></blockquote> <h3 id="_1-1-原子性问题产生的原因"><a href="#_1-1-原子性问题产生的原因" class="header-anchor">#</a> 1.1 原子性问题产生的原因</h3> <p>在多线程场景下，由于时间片在<strong>线程之间的切换</strong>，就会导致原子性问题的产生。</p> <blockquote><p>程序执行的时候，一定是以线程为单位执行的。因为<strong>线程是 CPU 进行任务调度的基本单位</strong>。</p> <p>CPU 会根据不同的任务调度算法，将时间片分派给各个线程，从而去调度线程的执行。</p> <p>时间片是 CPU 分配给各个线程的时间。时间片非常短，一般是几十毫秒（ms）。</p> <p>当某个线程获取了 CPU 的时间片之后，就获得了 CPU 的执行权，去执行该线程任务。</p> <p>当时间片耗尽之后，就会失去 CPU 的使用权。进而本任务会暂停执行，而去执行其他的线程任务。</p></blockquote> <h3 id="_1-2-案例分析-i"><a href="#_1-2-案例分析-i" class="header-anchor">#</a> 1.2 案例分析：i++</h3> <p>当多个线程去执行 <code>i++</code> 的时候会出现并发问题。<code>i++</code> 具体分为三个步骤执行（它是典型的读改写操作）：</p> <ol><li>从主内存中读取 <code>i</code> 的值，并且存储到线程的本地内存中（共享变量的副本）。</li> <li>线程根据本地内存的共享变量副本执行 <code>+1</code> 的操作。</li> <li>把本地内存中更新完成的共享变量 <code>i</code> 刷新到主内存中。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 启动十个线程，每个线程都执行 i++ 操作</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicityTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AtomicityTest</span> atomicTest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicityTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>atomicTest<span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicTest<span class="token punctuation">.</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上程序的输出结果不一定是 10，多运行几次，可以看到会出现小于 10 的情况。</p> <p>原因就是 <code>i++</code> 不是原子操作，而是一个符合操作。<code>volatile</code> 关键字是无法保证原子性的。</p> <h3 id="_1-3-如何保证原子性"><a href="#_1-3-如何保证原子性" class="header-anchor">#</a> 1.3 如何保证原子性</h3> <p>JMM 只保证了基本数据类型的访问和读写是具备原子性的（long 和 double 类型除外）。</p> <p>但是大多数情况下，需要更大范围的原子性保证。此时的实现方法有：</p> <ol><li>悲观锁：synchronized、lock</li> <li>乐观锁：原子类 CAS</li></ol> <p><em>注意：volatile 关键字无法保证原子性</em></p> <h2 id="_2-可见性"><a href="#_2-可见性" class="header-anchor">#</a> 2. 可见性</h2> <p>一个线程对于共享变量的修改，另外一个线程能够及时看到，就叫做可见性。</p> <h3 id="_2-1-可见性问题产生的原因"><a href="#_2-1-可见性问题产生的原因" class="header-anchor">#</a> 2.1 可见性问题产生的原因</h3> <p>在多线程场景下，<strong>缓存</strong>不能及时刷新到主内存中，是导致可见性问题产生的根本原因。</p> <h3 id="_2-2-案例分析"><a href="#_2-2-案例分析" class="header-anchor">#</a> 2.2 案例分析</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VisibilityTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        b <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a = &quot;</span> <span class="token operator">+</span> a <span class="token operator">+</span> <span class="token string">&quot;, b = &quot;</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">VisibilityTest</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VisibilityTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>test<span class="token operator">::</span><span class="token function">print</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>test<span class="token operator">::</span><span class="token function">change</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上程序的输出情况不一定是 <code>a = 1, b = 2</code> 或者 <code>a = 3, b = 3</code> ，多运行几次，可以看到会出现 <code>a = 1, b = 3</code> 的情况。</p> <p>原因就是第一个线程将值 <code>a = 3</code> 修改后，但是对第二个线程是不可见的，所以才出现这一结果。如果将 a 和 b 都改成 <code>volatile</code> 类型的变量再执行，则再也不会出现 <code>a = 1, b = 3</code> 的结果了。</p> <p>（本例参考自以下文章，我运行了多次没有出现第三种情况，但是已经可以说明问题了）</p> <h3 id="_2-3-如何保证可见性"><a href="#_2-3-如何保证可见性" class="header-anchor">#</a> 2.3 如何保证可见性</h3> <ol><li>synchronized、lock：锁释放之前必须把最新的值同步到主内存中，以此来保证可见性。</li> <li>volatile：被 volatile 修饰的变量，一个线程修改后立即把值同步到主内存中，其他线程使用前立即从主内存中刷新。</li> <li>final：被 final 修饰的字段在构造器中一旦初始化完成，并且构造器没有把 “this” 的引用传递出去（this 引用逃逸是一件很危险的事情，其他线程有可能通过这个引用访问到 “初始化了一半” 的对象），那在其他线程中就能看见 final 字段的值。</li></ol> <h2 id="_3-有序性"><a href="#_3-有序性" class="header-anchor">#</a> 3. 有序性</h2> <p>程序执行的顺序按照代码书写的顺序去执行，就叫做有序性。</p> <h3 id="_3-1-有序性问题产生的原因"><a href="#_3-1-有序性问题产生的原因" class="header-anchor">#</a> 3.1 有序性问题产生的原因</h3> <p>编译器和处理器<strong>为了提高程序执行的性能</strong>，会改变代码的执行顺序（写在前面的代码不一定是先被执行的），在多线程场景下就会导致有序性问题的产生（指令重排序不会影响单线程的执行）。</p> <h3 id="_3-2-实例分析-单例模式之-double-check-lock"><a href="#_3-2-实例分析-单例模式之-double-check-lock" class="header-anchor">#</a> 3.2 实例分析：单例模式之 Double Check Lock</h3> <p>利用双重检测锁定创建单例对象。双重检测锁定是只有当对象未创建的时候才加锁，对象创建以后不需要上锁。相对于懒汉式创建单例对象上来就加锁的方式，有效的提升了程序运行的效率。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> singleton <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 先检查对象是否创建</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 只有当对象未创建的时候才加锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>DCL 解决了单例模式中性能和资源浪费的情况。但是 DCL 在并发（多线程）情况下，由于指令重排序，会得到没有初始化的实例，进而可能导致空指针异常。（解决办法是将 singleton 修饰为 volatile 变量）</p> <p>具体分析：线程 A 调用 <code>getInstance()</code> 方法获取对象实例，因为对象还是 null 未进行初始化，此时线程 A 会执行 <code>new Singleton()</code> 进行对象实例化。而当线程 A 进行 <code>new Singleton()</code> 的时候 JVM 会生成三个指令：</p> <ul><li>指令1：给对象分配一块内存</li> <li>指令2：调用构造器，在内存中初始化对象</li> <li>指令3：将内存地址赋值给实例</li></ul> <p>经过编译器指令优化，实际执行顺序可能是：</p> <ul><li>指令1：给对象分配一块内存</li> <li>指令3：将内存地址赋值给实例</li> <li>指令2：调用构造器，在内存中初始化对象</li></ul> <p>当执行完指令3还没有执行指令2时，此时 CPU 切换到了线程 B 工作，线程 B 也调用了 <code>getInstance()</code> 方法获取对象实例，当线程 B 执行到 <code>if (singleton == null)</code> 发现对象不为空，那么线程 B 就得到了一个未被初始化的实例。</p> <h3 id="_3-3-如何保证有序性"><a href="#_3-3-如何保证有序性" class="header-anchor">#</a> 3.3 如何保证有序性</h3> <ol><li>synchronized、lock：一个变量在同一时刻只允许一条线程对其进行 lock 操作。这条规则也决定了持有同一个锁的两个同步代码块只能串行的执行。</li> <li>volatile：禁止指令重排序。</li></ol> <p>此外，JMM 通过 Happes-before 原则，具备一些天生的有序性规则，不需要任何同步方法就能保证有序性。如果两个操作无法从 Happens-before 推导出来，那么这两个操作就无法保证有序性，也就是说编译器或者处理器可以随意对它们进行重排序处理。</p> <p>参考：</p> <p>https://cloud.tencent.com/developer/article/1744660</p> <p>https://www.liaoxuefeng.com/wiki/1252599548343744/1304521607217185</p> <p>http://tutorials.jenkov.com/java-concurrency/concurrency-vs-parallelism.html</p> <p>https://www.cnblogs.com/sxkgeek/p/9397534.html</p> <p>https://geek-docs.com/java/java-concurrent/concurrent-programming-orderliness.html</p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1-原子性" title="1. 原子性">1. 原子性</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-1-原子性问题产生的原因" title="1.1 原子性问题产生的原因">1.1 原子性问题产生的原因</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-2-案例分析-i" title="1.2 案例分析：i++">1.2 案例分析：i++</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-3-如何保证原子性" title="1.3 如何保证原子性">1.3 如何保证原子性</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2-可见性" title="2. 可见性">2. 可见性</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-1-可见性问题产生的原因" title="2.1 可见性问题产生的原因">2.1 可见性问题产生的原因</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-2-案例分析" title="2.2 案例分析">2.2 案例分析</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-3-如何保证可见性" title="2.3 如何保证可见性">2.3 如何保证可见性</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3-有序性" title="3. 有序性">3. 有序性</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-1-有序性问题产生的原因" title="3.1 有序性问题产生的原因">3.1 有序性问题产生的原因</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-2-实例分析-单例模式之-double-check-lock" title="3.2 实例分析：单例模式之 Double Check Lock">3.2 实例分析：单例模式之 Double Check Lock</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-3-如何保证有序性" title="3.3 如何保证有序性">3.3 如何保证有序性</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>Privacy Policy</a></li><li class="copyright-item" data-v-3d9deeb8>MIT Licensed | Copyright © 2018-present Vue.js</li></ul></div></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/vssue-comment/assets/js/app.9fa4f4bb.js" defer></script><script src="/vssue-comment/assets/js/13.044f1fde.js" defer></script><script src="/vssue-comment/assets/js/3.f0de84e7.js" defer></script><script src="/vssue-comment/assets/js/27.d4ae83e5.js" defer></script>
  </body>
</html>
